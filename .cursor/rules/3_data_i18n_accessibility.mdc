---
alwaysApply: true
---

# üåç Data Fetching, i18n & Accessibility

## Data Fetching
- All API via `src/lib/http/client.ts`
- Base URL: `process.env.NEXT_PUBLIC_API_BASE_URL`
- **TanStack Query** for all client-side data fetching
- **HTTP Interceptors** for token management and error handling
- **Rate limiting** with event bus system
- Public-safe RSC only:
```ts
fetch(url, { next: { revalidate: 60, tags: ['posts'] } })
```
- Client hooks: `useQuery()` and `useMutation()` from TanStack Query
- **Query Configuration**: 5min staleTime, 10min gcTime, 3 retries with exponential backoff
- **Provider Setup**: `ReactQueryProvider` with devtools in development
- **Query Keys**: Structured keys like `["article", articleId]`, `["settings", userId]`
- **Error Handling**: Automatic retry with toast notifications via Sonner

## Forms & Validation
- `react-hook-form` + `zod` + shadcn `<Form />` primitives (`components/ui/layout/form.tsx`)
- Disable submit while pending
- Show `FormMessage` for errors
- **Toast notifications** with Sonner for feedback
- Respect mobile ergonomics (spacing, label click area)

## i18n

### Basic Usage
- All text in `src/i18n/locales/{en,vi}/*.json`
- **Namespaces**: `auth`, `article`, `common`, `demo`, `home`, `profile`, `toast`, `user`, `write`, `admin`
- Use `useI18n()` hook: `const { t } = useI18n();`
- **Function signature**: `t(key: string, namespace?: string, variables?: Record<string, unknown>, fallback?: string)`
- **Language switching** with dynamic locale switching

### Translation Function Usage

**‚úÖ CORRECT Patterns:**
```tsx
// Basic usage with namespace
t("actions.edit", "common")           // ‚úÖ Correct: actions.edit exists in common.json
t("actions.view", "common")          // ‚úÖ Correct: actions.view exists in common.json
t("actions.delete", "common")        // ‚úÖ Correct: actions.delete exists in common.json
t("common.actions", "common")        // ‚úÖ Correct: common.actions exists in common.json (nested object)

// Admin namespace
t("studios.detail.title", "admin")    // ‚úÖ Correct: studios.detail.title exists in admin.json
t("studios.list.name", "admin")      // ‚úÖ Correct: studios.list.name exists in admin.json

// With variables
t("studios.detail.title", "admin", { name: studio.name })
```

**‚ùå WRONG Patterns (Common Mistakes):**
```tsx
// ‚ùå WRONG: Key doesn't exist in common.json structure
t("common.view", "common")           // ‚ùå Should be: t("actions.view", "common")
t("common.edit", "common")           // ‚ùå Should be: t("actions.edit", "common")
t("common.delete", "common")         // ‚ùå Should be: t("actions.delete", "common")

// ‚ùå WRONG: Missing namespace
t("actions.edit")                    // ‚ùå Always specify namespace as second parameter

// ‚ùå WRONG: Wrong namespace
t("actions.edit", "admin")           // ‚ùå actions.edit is in "common" namespace, not "admin"
```

### Common.json Key Structure

**Important:** Understand the structure of `common.json`:

```json
{
  "actions": {
    "edit": "Edit",
    "view": "View",
    "delete": "Delete",
    "save": "Save",
    // ... all action verbs
  },
  "common": {
    "actions": "Actions"  // This is a label, not the actions object
  },
  "viewDetails": "View Details",
  // ... other root-level keys
}
```

**Key Rules:**
1. **Action verbs** are in `actions.*` ‚Üí Use `t("actions.{verb}", "common")`
   - Examples: `actions.edit`, `actions.view`, `actions.delete`, `actions.save`, `actions.cancel`
2. **Labels** like "Actions" are in `common.*` ‚Üí Use `t("common.{label}", "common")`
   - Example: `common.actions` (the label "Actions")
3. **Root-level keys** ‚Üí Use `t("{key}", "common")`
   - Examples: `viewDetails`, `admin`, `create`

### Namespace Selection Rules

1. **`common` namespace**: Use for generic UI elements, actions, and shared text
   - Action buttons: `actions.edit`, `actions.delete`, `actions.view`, etc.
   - Common labels: `common.actions`, `viewDetails`
   - Generic messages: `all`, `clearFilters`, etc.

2. **`admin` namespace**: Use for admin-specific content
   - Admin pages: `studios.*`, `users.*`, `characters.*`, etc.
   - Admin-specific labels and messages

3. **Domain namespaces**: Use for domain-specific content
   - `auth.*` for authentication
   - `article.*` for articles
   - `user.*` for user profiles
   - etc.

### Best Practices

1. **Always specify namespace explicitly**:
   ```tsx
   // ‚úÖ Good
   t("actions.edit", "common")
   
   // ‚ùå Bad (relies on default, unclear)
   t("actions.edit")
   ```

2. **Use consistent key patterns**:
   - Actions: `actions.{verb}`
   - Labels: `{domain}.{section}.{field}` (e.g., `studios.detail.title`)
   - Messages: `{domain}.{type}.{message}` (e.g., `studios.list.deleteConfirm`)

3. **Check key existence before using**:
   - Verify the key exists in the JSON file
   - Use TypeScript autocomplete when possible
   - Check both `en` and `vi` locales

4. **Use variables for dynamic content**:
   ```tsx
   t("studios.detail.title", "admin", { name: studio.name })
   t("studios.list.deleteConfirm", "admin", { name: studio.name })
   ```

5. **Provide fallback for missing keys** (optional but recommended):
   ```tsx
   t("actions.edit", "common", {}, "Edit")
   ```

### Common Mistakes to Avoid

1. **‚ùå Confusing `common.actions` with `actions.*`**:
   - `common.actions` = The label "Actions" (string)
   - `actions.*` = Action verbs (edit, delete, view, etc.)

2. **‚ùå Using wrong namespace**:
   - Action verbs are in `common`, not `admin`
   - Domain-specific content is in domain namespace, not `common`

3. **‚ùå Missing namespace parameter**:
   - Always provide namespace as second parameter

4. **‚ùå Incorrect key path**:
   - Check the actual JSON structure before using keys
   - Use dot notation for nested keys: `studios.detail.series.title`

### Verification Checklist

Before using a translation key, verify:
- [ ] Key exists in the JSON file structure
- [ ] Namespace is correct (`common` vs `admin` vs domain namespace)
- [ ] Key path matches the JSON structure (check nesting)
- [ ] Both `en` and `vi` locales have the key
- [ ] Variables are provided if the key requires them

## Accessibility
- AA contrast in both themes
- Keyboard nav (Tab, ESC)
- `aria-live="polite"` for async feedback
- `VisuallyHidden` for non-visual labels
- **Focus management** in dialogs and modals
- **Screen reader** friendly components

## Page Metadata & SEO
- **usePageMetadata Hook** (`@/hooks/ui/use-page-metadata`): Update page title, meta tags, Open Graph, Twitter Cards, canonical URL
- Use for all client component pages to improve SEO and social sharing
- Automatically formats title as: `"{title} | MangaSBS"`
- Updates: `document.title`, meta description, OG tags, Twitter Card, canonical link
- **Example:**
```tsx
usePageMetadata({
  title: "Series Title",
  description: "Series description",
  image: "https://example.com/cover.jpg",
  url: "https://example.com/series/123",
  keywords: ["manga", "series"],
  type: "article"
});
```

## Breadcrumb Navigation
- **useBreadcrumb Hook** (`@/hooks/ui/useBreadcrumb`): Automatic breadcrumb generation with i18n support
- **BreadcrumbNav Component** (`@/components/features/navigation/breadcrumb-nav`): Renders breadcrumb navigation
- Supports dynamic params (titles, usernames, IDs) and translation keys
- Translation keys use `nav.breadcrumb.*` in `common.json` namespace
- **Auto-detection:** Automatically matches known routes (organizations, series, segments, articles, user)
- **Custom breadcrumbs:** Pass items array directly to `useBreadcrumb([...])`
- **Example:**
```tsx
const breadcrumbItems = useBreadcrumb(undefined, {
  series_id: seriesId,
  series_title: series?.title,
});
<BreadcrumbNav items={breadcrumbItems} />
```
